#include <WiFi.h>
#include <WiFiClient.h>
#include <WebServer.h>
#include <ESPmDNS.h>
#include <EEPROM.h>

const char *ssid = "Project_nano";
const char *password = "123456789";

IPAddress apIP(192, 168, 1, 5);
IPAddress gatewayIP(192, 168, 1, 1);
IPAddress subnetIP(255, 255, 255, 0);

WebServer server(80);

// Function to write a string to EEPROM
void writeStringToEEPROM(int addr, const String &str) {
  for (size_t i = 0; i < str.length(); i++) {
    EEPROM.write(addr + i, str[i]);
  }
  EEPROM.write(addr + str.length(), '\0'); // Null-terminate the string
  EEPROM.commit(); // Commit changes to EEPROM
}

// Function to read a string from EEPROM
String readStringFromEEPROM(int addr) {
  String result = "";
  char ch = EEPROM.read(addr);
  while (ch != '\0') {
    result += ch;
    addr++;
    ch = EEPROM.read(addr);
  }
  return result;
}

void handleRoot() {
  String html = "<html><body>";
  html += "<h1 style=\"color:blue;\">Project nano</h1>";
  html += "<h2 style=\"color:black;\">This project was developed by Mr. Chainarong Kulchim (medical scientist) </h2>";
  html += "<h2 style=\"color:black;\">Veterinary Research and Development Center Lower Northern Region</h2>";
  html += "<h2 style=\"color:black;\">9 Moo.15 Phitsanulok-Lomsak road Wangthong Phitsanulok 65130</h2>";
  html += "<h2 style=\"color:black;\">Email: chainarong681@gmail.com Tel.0805040716</h2>";

  // เพิ่มขนาดและเปลี่ยนสีปุ่ม
  html += "<button style=\"font-size: 30px; background-color: lightgreen;\" onclick=\"goToSecondPage()\">Run program</button>  ";
  html += "<button style=\"font-size: 30px; background-color: lightyellow;\" onclick=\"goToThirdPage()\">Setting program</button>  ";
  html += "<button style=\"font-size: 30px; background-color: lightpink;\" onclick=\"goToFourthPage()\">Calibration</button>";

  html += "<script>function goToSecondPage() { window.location.href = '/second'; }</script>";
  html += "<script>function goToThirdPage() { window.location.href = '/third'; }</script>";
  html += "<script>function goToFourthPage() { window.location.href = '/Fourth'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void handleSecondPage() {
  String html = "<html><body>";
  html += "<button style='font-size: 30px; background-color: lightgreen;' onclick='goToRoot()'>Back</button>";
  html += "<h1>Project NANO Run:</h1>";

  // Read values from EEPROM
  String method = readStringFromEEPROM(0);
  String time = readStringFromEEPROM(5);
  String tempC = readStringFromEEPROM(10);

  html += "<p>Method: " + method + "</p>";
  html += "<p>Time: " + time + "</p>";
  html += "<p>Temp Correction: " + tempC + "</p>";

  html += "<script>function goToRoot() { window.location.href = '/'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void handleThirdPage() {
  String html = "<html><body>";
  html += "<button style='font-size: 30px; background-color: lightgreen;' onclick='goToRoot()'>Back</button>";
  html += "<h1>Amplification method setting:</h1>";
  html += "<form action='/submit' method='post'>";
  html += "<label for='methods' style='font-size: 24px;'>Choose a method: </label>";
  html += "<select name='methods' id='methods' style='font-size: 24px;'>";
  html += "<option value='37'>Recombinase Polymerase Amplification(37 'C)</option>";
  html += "<option value='42'>Recombinase Polymerase Amplification(42 'C)</option>";
  html += "<option value='60'>Loop-mediated isothermal amplification(60 'C)</option>";
  html += "<option value='65'>Loop-mediated isothermal amplification(65 'C)</option>";
  html += "</select><br><br>";
  html += "<label for='time' style='font-size: 24px;'>Choose a time: </label>";
  html += "<select name='time' id='time' style='font-size: 24px;'>";
  html += "<option value='30'>30 min</option>";
  html += "<option value='60'>60 min</option>";
  html += "<option value='90'>90 min</option>";
  html += "</select><br><br>";
  html += "<input type='submit' value='Submit' style='font-size: 20px; width: 100px; height: 30px; background-color: yellow;'>";
  html += "</form>";
  html += "<script>function goToRoot() { window.location.href = '/'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void handleThirdPageSubmit() {
  String method = server.arg("methods");
  String time = server.arg("time");

  // Assuming you have enough space in EEPROM for the method and time strings
  writeStringToEEPROM(0, method);
  writeStringToEEPROM(5, time);

  // Print the saved values to Serial
  Serial.println("Method: " + method);
  Serial.println("Time: " + time);

  // Assuming you have some condition to determine success or failure
  bool success = true; // Change this based on your actual condition

  String message;
  String color;

  if (success) {
    message = "Data saved successfully";
    color = "green";
  } else {
    message = "Failed to save data";
    color = "red";
  }

  String html = "<html><body>";
  html += "<h1 style='color:" + color + "'>" + message + "</h1>";
  html += "<button style='font-size: 30px; background-color: lightgreen;' onclick='goToThirdPage()'>Back</button>";
  html += "<script>function goToThirdPage() { window.location.href = '/third'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void handleFourthPage() {
  String html = "<html><body>";
  html += "<button style='font-size: 30px; background-color: lightgreen;' onclick='goToRoot()'>Back</button>";
  html += "<h1 style='font-size: 24px;'>Temperature calibration:</h1>";
    // เพิ่มฟอร์ม input ข้อมูล
  html += "<form action='/submitFourth' method='post' onsubmit='return validateForm()'>";
  html += "<label for='tempC' style='font-size: 24px;'>Temp correction ('C): </label>";
  html += "<input type='text' id='tempC' name='tempC' style='font-size: 24px;' required><br><br>";
  html += "<input type='submit' value='Submit' style='font-size: 20px; width: 100px; height: 30px; background-color: yellow;'>";
  html += "</form>";

  html += "<script>";
  html += "function validateForm() {";
  html += "  var tempCValue = document.getElementById('tempC').value;";
  html += "  if (!tempCValue || isNaN(tempCValue)) {";
  html += "    alert('Please enter a valid numeric value for Temp correction.');";
  html += "    return false;";
  html += "  }";
  html += "}";
  html += "</script>";


  html += "<script>function goToRoot() { window.location.href = '/'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}

void handleFourthPageSubmit() {
  String tempC = server.arg("tempC");

  // Assuming you have enough space in EEPROM for the tempC string
  writeStringToEEPROM(10, tempC);

  // Print the saved value to Serial
  Serial.println("Temp Correction: " + tempC);

  // Assuming you have some condition to determine success or failure
  bool success = true; // Change this based on your actual condition

  String message;
  String color;

  if (success) {
    message = "Temperature correction saved successfully";
    color = "green";
  } else {
    message = "Failed to save data";
    color = "red";
  }

  String html = "<html><body>";
  html += "<h1 style='color:" + color + "'>" + message + "</h1>";
  html += "<button style='font-size: 30px; background-color: lightgreen;' onclick='goToFourthPage()'>Back</button>";
  html += "<script>function goToFourthPage() { window.location.href = '/Fourth'; }</script>";
  html += "</body></html>";

  server.send(200, "text/html", html);
}


void setup() {
  Serial.begin(115200);

  WiFi.softAP(ssid, password);
  delay(100);

  WiFi.softAPConfig(apIP, gatewayIP, subnetIP);

  Serial.println("Access Point IP address: " + WiFi.softAPIP().toString());

  EEPROM.begin(512);  // Begin with EEPROM size

  server.on("/", HTTP_GET, handleRoot);
  server.on("/second", HTTP_GET, handleSecondPage);
  server.on("/third", HTTP_GET, handleThirdPage);
  server.on("/submit", HTTP_POST, handleThirdPageSubmit); // New route for form submission

  server.on("/Fourth", HTTP_GET, handleFourthPage);
  server.on("/submitFourth", HTTP_POST, handleFourthPageSubmit);


  server.begin();

  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();

  // Print values from EEPROM to Serial
  printValuesFromEEPROM();
  // Add a delay if needed to control the frequency of printing
  delay(1000);  // Adjust the delay time as needed
}

void printValuesFromEEPROM() {
  // Read values from EEPROM
  String method = readStringFromEEPROM(0);
  String time = readStringFromEEPROM(5);
  String tempC = readStringFromEEPROM(10);

  // Print values to Serial
  Serial.println("Method: " + method);
  Serial.println("Time: " + time);
  Serial.println("Temp Correction: " + tempC);
}
